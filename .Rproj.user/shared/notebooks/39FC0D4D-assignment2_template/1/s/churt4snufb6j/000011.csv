"0","# Spatial join tracts to counties"
"0","vuln_for_join <- vulnerable_tracts %>%"
"0","  st_transform(st_crs(pa_counties))"
"0",""
"0","# Spatial join: attach county names to vulnerable tracts"
"0","vuln_county <- vuln_for_join %>%"
"0","  st_join(pa_counties %>% select(COUNTY_NAM), left = TRUE)"
"0",""
"0","# Aggregate statistics by county"
"0","county_stats <- pa_counties %>%"
"0","  st_drop_geometry() %>%"
"0","  select(COUNTY_NAM) %>%"
"0","  left_join("
"0","    vuln_county %>%"
"0","      st_drop_geometry() %>%"
"0","      group_by(COUNTY_NAM) %>%"
"0","      summarise("
"0","        vulnerable_tracts    = n(),"
"0","        underserved_tracts   = sum(underserved, na.rm = TRUE),"
"0","        avg_dist_mi          = mean(dist_mi, na.rm = TRUE),"
"0","        vulnerable_pop       = sum(over65_total, na.rm = TRUE),"
"0","        underserved_vuln_pop = sum(ifelse(underserved, over65_total, 0), na.rm = TRUE),"
"0","        .groups = ""drop"""
"0","      ),"
"0","    by = ""COUNTY_NAM"""
"0","  ) %>%"
"0","  mutate("
"0","    across(c(vulnerable_tracts, underserved_tracts, avg_dist_mi,"
"0","             vulnerable_pop, underserved_vuln_pop),"
"0","           ~ tidyr::replace_na(., 0)),"
"0","    pct_underserved = dplyr::if_else("
"0","      vulnerable_tracts > 0,"
"0","      100 * underserved_tracts / vulnerable_tracts,"
"0","      0"
"0","    )"
"0","  )"
"0",""
"0","top5_pct_underserved <- county_stats %>%"
"0","  arrange(desc(pct_underserved), desc(avg_dist_mi)) %>%"
"0","  slice_head(n = 5) %>%"
"0","  pull(COUNTY_NAM)"
"0",""
"0","top5_vuln_people_far <- county_stats %>%"
"0","  arrange(desc(underserved_vuln_pop)) %>%"
"0","  slice_head(n = 5) %>%"
"0","  pull(COUNTY_NAM)"
"0",""
